<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PBE Quiz Analytics Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #4CAF50; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
    .stat-card { background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center; }
    .stat-number { font-size: 2em; font-weight: bold; color: #4CAF50; }
    .chart-container { margin: 20px 0; height: 400px; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #4CAF50; color: white; }
    .error { color: red; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>✝️ PBE Quiz Analytics Dashboard</h1>
    <div id="loading">Loading data...</div>
<div id="dashboard" style="display: none;">
  <!-- Name Filter -->
  <select id="childFilter" onchange="filterData()" style="margin: 10px; padding: 5px;">
    <option value="">All Children</option>
    <!-- Auto-populate from data in JS -->
  </select>

  <!-- Rest of stats/charts/tables... -->
</div>

<script>
// Add after renderDashboard()
function renderDashboard(scores, logs) {
  // ... existing code ...
  
  // Populate filter
  const uniqueNames = [...new Set(scores.map(s => s[0]))].sort();
  const filterSel = document.getElementById('childFilter');
  uniqueNames.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    filterSel.appendChild(opt);
  });
}

function filterData() {
  const filterName = document.getElementById('childFilter').value;
  const filteredScores = filterName ? scores.filter(s => s[0] === filterName) : scores;
  const filteredLogs = filterName ? logs.filter(l => l[0] === filterName) : logs;
  // Re-render tables/charts with filtered data
  renderScoresTable(filteredScores);
  renderLogsTable(filteredLogs.slice(-10));
  // Update charts if needed
}
</script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyCW4HPKLULoW0GwhDjlbBdzeekWYElEIC-0Jws_5I1L32KOFqcDXqlCaaUR0FdGn0QEg/exec?action=dashboard";  // Replace with your redeployed URL

    let scoresChart, timeChart, chapterChart;

    async function loadData() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error('Failed to fetch data');
        const data = await response.json();
        renderDashboard(data.scores, data.logs);
      } catch (error) {
        document.getElementById('loading').innerHTML = `<div class="error">Error loading data: ${error.message}</div>`;
      }
    }

    function renderDashboard(scores, logs) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';

      // Stats
      const totalQuizzes = scores.length;
      const avgScore = scores.length ? Math.round(scores.reduce((sum, s) => sum + s[2], 0) / totalQuizzes) : 0;
      const avgTime = scores.length ? Math.round(scores.reduce((sum, s) => sum + s[7], 0) / totalQuizzes) : 0;
      const correctRate = scores.length ? Math.round(scores.reduce((sum, s) => sum + s[4], 0) / scores.reduce((sum, s) => sum + s[3], 0) * 100) : 0;

      document.getElementById('totalQuizzes').textContent = totalQuizzes;
      document.getElementById('avgScore').textContent = avgScore;
      document.getElementById('avgTime').textContent = avgTime;
      document.getElementById('correctRate').textContent = correctRate;

      // Charts
      renderScoreChart(scores);
      renderTimeChart(logs);
      renderChapterChart(logs);

      // Tables
      renderScoresTable(scores);
      renderLogsTable(logs.slice(-10));  // Last 10
    }

    function renderScoreChart(scores) {
      const ctx = document.getElementById('scoreChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: scores.map(s => s[0] + ' (' + s[1] + ')'),  // Name (Date)
          datasets: [{ label: 'Score %', data: scores.map(s => s[2]), backgroundColor: '#4CAF50' }]
        },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
      });
    }

    function renderTimeChart(logs) {
      const ctx = document.getElementById('timeChart').getContext('2d');
      const responseTimes = logs.map(l => l[5]);  // ResponseTime
      const viewTimes = logs.map(l => l[4]);  // TimeToViewAnswer
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: logs.map((_, i) => `Q${i+1}`),
          datasets: [
            { label: 'Response Time (s)', data: responseTimes, borderColor: '#FF9800' },
            { label: 'View Answer Time (s)', data: viewTimes, borderColor: '#2196F3' }
          ]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    function renderChapterChart(logs) {
      const ctx = document.getElementById('chapterChart').getContext('2d');
      const chapterCorrect = {};
      logs.forEach(l => {
        const ch = l[2].split(' ')[1].split(':')[0];  // Extract chapter from Ref
        if (!chapterCorrect[ch]) chapterCorrect[ch] = { correct: 0, total: 0 };
        chapterCorrect[ch].correct += l[3] ? 1 : 0;
        chapterCorrect[ch].total += 1;
      });
      const labels = Object.keys(chapterCorrect);
      const data = labels.map(ch => Math.round(chapterCorrect[ch].correct / chapterCorrect[ch].total * 100));
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels.map(ch => `Ch. ${ch}`),
          datasets: [{ data: data, backgroundColor: ['#4CAF50', '#FF9800', '#2196F3', '#F44336'] }]
        },
        options: { plugins: { legend: { position: 'bottom' } } }
      });
    }

    function renderScoresTable(scores) {
      const tbody = document.querySelector('#scoresTable tbody');
      tbody.innerHTML = scores.slice(-10).reverse().map(s => `<tr><td>${s[0]}</td><td>${s[1]}</td><td>${s[2]}%</td><td>${s[3]}</td><td>${s[8]}s</td><td>${s[9]}s</td></tr>`).join('');
    }

    function renderLogsTable(logs) {
      const tbody = document.querySelector('#logsTable tbody');
      tbody.innerHTML = logs.map(l => `<tr><td>${l[0]}</td><td>${l[2]}</td><td>${l[3] ? 'Yes' : 'No'}</td><td>${l[5]}s</td><td>${l[4]}s</td><td>${l[6]}</td><td>${l[8] ? 'Yes' : 'No'}</td></tr>`).join('');
    }

    loadData();  // Auto-load on page open
  </script>
</body>
</html>
