<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Oxford Academics PBE Quiz</title>
  <style>
    :root {
      --primary: #4CAF50;
      --light: #f9f9f9;
      --dark: #333;
    }
    body {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: linear-gradient(to bottom, #e0f7fa, #ffffff);
      margin: 0; padding: 1rem; color: var(--dark);
    }
    h1 { text-align: center; color: var(--primary); }
    .card {
      background: white; border-radius: 12px; padding: 1.5rem;
      margin: 1rem auto; max-width: 600px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    select, button, input {
      font-size: 1.1rem; padding: 0.6rem; margin: 0.5rem 0;
      border-radius: 8px; border: 1px solid #ccc;
    }
    button {
      background: var(--primary); color: white; cursor: pointer;
      transition: 0.2s;
    }
    button:hover { background: #45a049; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .question { font-size: 1.3rem; margin: 1.5rem 0; }
    .reference { font-weight: bold; color: var(--primary); }
    .answer { margin: 1rem 0; padding: 1rem; background: #e8f5e9; border-radius: 8px; display: none; }
    .timer { font-size: 2rem; text-align: center; color: #ff9800; margin: 1rem 0; font-weight: bold; }
    .options { display: flex; gap: 1rem; justify-content: center; margin-top: 1rem; }
    .summary { text-align: center; font-size: 1.4rem; }
    .hidden { display: none; }
    .got-it { background: #4CAF50; }
    .incorrect { background: #f44336; }
    .test-complete { 
      font-size: 1.6rem; 
      color: var(--primary); 
      margin-bottom: 1rem; 
      display: block !important;  
      font-weight: bold;
      text-align: center;
    }
    /* Center all buttons */
    .card button, .summary button {
      display: block;
      margin: 0.5rem auto;
      width: 100%;
      max-width: 200px;
    }
    .options button {
      flex: 1;
      max-width: none;
    }
    .skip-btn { background: #757575; }
    @media (max-width: 480px) {
      .card { padding: 1rem; }
      .options { flex-direction: column; }
    }
    /* Footer credit */
    .footer-credit {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-size: 0.8rem;
      color: #666;
      text-align: right;
      z-index: 1000;
    }
    /* Isaiah Summary Styles */
    .isaiah-summary {
      max-width: 800px;
      line-height: 1.6;
      text-align: left;
    }
    .isaiah-summary h2 {
      color: var(--primary);
      text-align: center;
      font-size: 2rem;
    }
    .isaiah-summary h3 {
      color: #ff9800;
      font-size: 1.4rem;
      margin-top: 1.5rem;
    }
    .isaiah-summary p {
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }
    .isaiah-summary ol {
      padding-left: 1.5rem;
    }
    .isaiah-summary li {
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    .nav-buttons {
      text-align: center;
      margin: 1rem 0;
    }
    .nav-buttons button {
      margin: 0 0.5rem;
    }
    /* Wizard Styles */
    .wizard-step {
      display: none;
    }
    .wizard-step.active {
      display: block;
    }
    .wizard-progress {
      text-align: center;
      margin: 1rem 0;
      font-size: 1.2rem;
      color: var(--primary);
      font-weight: bold;
    }
    .wizard-buttons {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    .wizard-buttons button {
      flex: 1;
      max-width: 150px;
    }
    .wizard-finished {
      text-align: center;
      font-size: 1.5rem;
      color: var(--primary);
      padding: 1rem;
    }
    @media (max-width: 480px) {
      .wizard-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <h1>‚úùÔ∏è Oxford Academics PBE Quiz</h1>
  <div class="nav-buttons">
    <button onclick="showIsaiahSummary()">View Isaiah Summary üìñ</button>
    <button onclick="showConfig()" style="display: none;" id="backToConfig">Back to Quiz</button>
  </div>

  <!-- ==== ISAIAH SUMMARY WIZARD ==== -->
  <div id="isaiah-summary" class="card hidden">
    <h2>Isaiah: A Super Cool Book from the Bible</h2>
    <div class="isaiah-summary">
      <!-- Step 0: Intro -->
      <div id="step-0" class="wizard-step active">
        <p>Hey there! Imagine the Bible is like a huge adventure story with 66 chapters (called "books"). The Book of Isaiah is like a tiny version of the whole Bible‚Äîit's got exactly 66 chapters too! It's written by a guy named Isaiah, who was like God's messenger (called a prophet) a super long time ago, about 700 years before Jesus was born. Isaiah's job was to tell people: "Hey, God loves you SO much, but listen up and follow Him!"</p>
        <p>The first part (chapters 1-39) is like the Old Testament part of the Bible. It's all about God saying: "I'm your amazing Creator! There's no one like Me. I take care of you like a loving parent‚Äîgiving you food, home, and hugs (well, blessings!). But if you ignore Me and chase silly fake gods or hurt others, things get tough. It's like a time-out to help you come back. And guess what? When you're sorry and run back to Me, I ALWAYS forgive you. No matter what!"</p>
        <p>The second part (chapters 40-66) is like the New Testament‚Äîfull of hope! It talks about Jesus (called the Messiah), how He beats bad stuff like sin, saves everyone who believes, and makes a perfect world with no more sadness or ouchies.</p>
        <p>Isaiah gets mentioned in the New Testament more than ANY other prophet‚Äîlike he's the Bible's MVP! It's packed with treasures about God's big love, how He chases after us like a shepherd finding a lost lamb, and pulls us close again. But you gotta read it slow, like unwrapping a gift, to find all the shiny bits!</p>
        <p>Now, let's zoom out and see the whole adventure in easy chunks:</p>
      </div>

      <!-- Step 1: Chapters 1-6 -->
      <div id="step-1" class="wizard-step">
        <strong>(Chapters 1-6): A Big Wake-Up Call!</strong><br>
        Isaiah gets a special job from God to tell his country (like a big family) to stop being naughty and come home to God. He keeps saying: "If you love and obey God, you'll get awesome blessings‚Äîlike sunshine after rain! But if you keep fighting Him or ditching Him like an old toy, there will be trouble." It's like God saying, "I want to clean your heart sparkling white, like fresh snow!" (Isaiah 1:18). Then Isaiah sees God on His giant throne‚Äîsuper holy and wow!‚Äîand says, "Send me! I'll tell everyone!" (Isaiah 6:8). Brave, right?
      </div>

      <!-- Step 2: Chapters 7-12 -->
      <div id="step-2" class="wizard-step">
        <strong>(Chapters 7-12): Heroes and Happy Endings!</strong><br>
        God saves Isaiah's land (Judah) from mean bully countries like Syria and Assyria. He even predicts a huge bad guy army will come... but then fall‚Äîpoof! And the best part? God promises a forever hero, the Messiah (Jesus!), who will rescue everyone for good. Remember that Christmas song? "For unto us a child is born!" Yeah, that's from here: Isaiah 9:6 says He's our Wonderful Counselor, Mighty God, Everlasting Father, Prince of Peace. Yay!
      </div>

      <!-- Step 3: Chapters 13-23 -->
      <div id="step-3" class="wizard-step">
        <strong>(Chapters 13-23): Messages to the Neighborhood Bullies!</strong><br>
        Isaiah sends "hey, watch out!" notes to all the grumpy countries around‚Äîlike Babylon, Assyria, Egypt, and more (even places like Moab and Tyre). It's like God warning: "Stop being mean and proud! Turn around, or there will be big trouble." Kinda like telling a kid to share toys before they lose them.
      </div>

      <!-- Step 4: Chapters 24-35 -->
      <div id="step-4" class="wizard-step">
        <strong>(Chapters 24-35): Beating the Big Bad Guy and Party Time!</strong><br>
        The whole world is in a mess because of the devil (Satan) and our yucky choices. But God says, "Don't worry‚ÄîI'll save My kids!" Then comes the Messiah's kingdom: a happy place where everyone is safe and sings songs about the new, perfect earth (no more thorns or tears‚ÄîChapter 35 is like a victory parade!). God whispers: "If you trust Me, I'll keep your heart super peaceful, like a calm lake." (Isaiah 26:3). Cool, huh?
      </div>

      <!-- Step 5: Chapters 36-39 -->
      <div id="step-5" class="wizard-step">
        <strong>(Chapters 36-39): A Real-Life Adventure Break!</strong><br>
        This is like a history movie: Bad guys from Assyria attack! But King Hezekiah prays super hard, and God sends help‚Äîzoom, they're gone! Then Hezekiah gets really sick, but God heals him. It's God's way of saying, "See? I notice when you call Me. I'm right here!"
      </div>

      <!-- Step 6: Chapters 40-53 -->
      <div id="step-6" class="wizard-step">
        <strong>(Chapters 40-53): Songs About God's Special Helper!</strong><br>
        These chapters are like love letters from God, full of "don't give up!" pep talks. "If you wait for Me, I'll give you eagle wings to fly high!" (Isaiah 40:31). And when life feels scary‚Äîlike deep water or hot fire‚ÄîGod says, "I'm holding your hand the whole time!" (Isaiah 43:2). There are four special "Servant Songs" about Jesus, who takes all our oopsies on Himself so we can be friends with God forever. It's the good news story before it even happened!
      </div>

      <!-- Step 7: Chapters 54-62 -->
      <div id="step-7" class="wizard-step">
        <strong>(Chapters 54-62): Good News for EVERYONE!</strong><br>
        God says, "This happy-saving news isn't just for My first family‚Äîit's for ALL kids everywhere, like you and your friends from every country!" No one else could save us, so God did it alone... but He invites us to join the party. "I see the mess, but I'll fix it with My strong arm!" (Isaiah 59:16). It's like a giant welcome hug for the whole world.
      </div>

      <!-- Step 8: Chapters 63-66 -->
      <div id="step-8" class="wizard-step">
        <strong>(Chapters 63-66): The Grand Finale‚ÄîGod Wins!</strong><br>
        In the end, God beats all the bad stuff (thanks to Jesus on the cross!). He makes a shiny new kingdom where His good kids‚Äîcleaned up and safe forever‚Äîlive happily. It's like the Book of Revelation: a brand-new earth with no more boo-boos! God even says, "I'll answer your prayers before you finish asking!" (Isaiah 65:24). What a happy ending!
      </div>

      <!-- Step 9: Closing -->
      <div id="step-9" class="wizard-step">
        <p>See? Isaiah shows God's heart: He's like the best Dad ever‚Äîstrong, kind, and always calling you home. Grab a Bible (or ask a grown-up to read with you) and dive in‚Äîit's an epic quest! What part sounds most fun to you?</p>
      </div>

      <div id="wizard-progress" class="wizard-progress">Step 1 of 10</div>

      <div id="wizard-buttons" class="wizard-buttons">
        <button id="prev-btn" onclick="prevStep()" disabled>‚Üê Back</button>
        <button id="next-btn" onclick="nextStep()">Next ‚Üí</button>
      </div>

      <div id="wizard-finished" class="wizard-finished hidden">
        <h3>üéâ You finished the Isaiah Adventure! Great job exploring God's story! üèÜ</h3>
        <p>Now you're ready for the quiz‚Äîhead back and test your knowledge!</p>
        <button onclick="resetWizard()">Read Again from Start üîÑ</button>
      </div>
    </div>
    <div class="nav-buttons">
      <button onclick="showConfig()">Back to Quiz</button>
    </div>
  </div>

  <!-- ==== CONFIG ==== -->
  <div id="config" class="card">
    <label><strong>Your Name:</strong></label><br>
    <select id="userName">
      <option value="">Select Name...</option>
      <option value="Coach">Coach</option>
      <option value="Kudzie">Kudzie</option>
      <option value="Wandie">Wandie</option>
      <option value="Lily">Lily</option>
      <option value="Abigail">Abigail</option>
      <option value="Micheala">Micheala</option>
      <option value="Dereal">Dereal</option>
      <option value="Caleb">Caleb</option>
      <option value="TJ">TJ</option>
      <option value="Jaydon">Jaydon</option>
      <option value="Sunshine">Sunshine</option>
    </select><br><br>

    <label><strong>Choose Book:</strong></label><br>
    <select id="bookSelect"></select><br><br>

    <label><strong>Choose Chapters (hold Ctrl/Cmd to select many):</strong></label><br>
    <select id="chapterSelect" multiple size="8"></select><br><br>

    <label><strong>Number of Questions:</strong></label><br>
    <select id="numQuestions">
      <option value="5">5</option>
      <option value="30">30</option>
      <option value="60">60</option>
      <option value="90">90</option>
    </select><br><br>

    <button onclick="startQuiz()">Start Quiz üöÄ</button>
  </div>

  <!-- ==== QUIZ ==== -->
  <div id="quiz" class="card hidden">
    <div class="reference" id="ref"></div>
    <div class="question" id="qtext"></div>
    <div class="timer" id="timer">30</div>
    <div class="answer" id="answer"></div>

    <div class="options" id="preAnswerOptions">
       <input 
        type="text" 
        id="userInput" 
        placeholder="Type your answer here..." 
        style="display:none; width:100%; padding:0.5rem; font-size:1rem; margin-top:0.5rem;"
      />
      <button id="showAnswer" onclick="onShowAnswer()">Show Answer ‚ùì</button>
      <button id="skipBtn" class="skip-btn" onclick="onSkip()">Skip ‚è≠Ô∏è</button>
    </div>

    <div class="options hidden" id="markOptions">
      <button class="got-it" onclick="markAnswer(true)">‚úÖ I Got It!</button>
      <button class="incorrect" onclick="markAnswer(false)">‚ùå Incorrect</button>
    </div>

    <div style="margin-top:1rem; text-align:center;">
      <strong>Progress:</strong> <span id="progress">0 / 0</span>
    </div>
  </div>

  <!-- ==== SUMMARY ==== -->
  <div id="summary" class="card hidden summary">
    <h2>üéâ Quiz Complete!</h2>
    <div class="test-complete">Test Complete! Great Job! üèÜ</div>
    <p><strong>Hi <span id="nameDisplay"></span>!</strong></p>
    <p><strong>Total Questions:</strong> <span id="totalQ"></span></p>
    <p><strong>Marks Earned:</strong> <span id="earned"></span> / <span id="possible"></span></p>
    <p><strong>Percentage:</strong> <span id="percent"></span>%</p>
    <button onclick="location.reload()">Test Again</button>
  </div>

  <!-- Footer Credit -->
  <div class="footer-credit">Developed by Oxford SDA Church</div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzece46ltf8T5A_PIgbTZmkEUGF9F-ubkNfTu4L7DY22kFy6BFuUJX5p9MKxP1TJKO5sg/exec";

    const chaptersPerBook = {
      "1 Chronicles": 29, "1 Corinthians": 16, "1 John": 5, "1 Kings": 22, "1 Peter": 5,
      "1 Samuel": 31, "1 Thessalonians": 5, "1 Timothy": 6, "2 Chronicles": 36,
      "2 Corinthians": 13, "2 John": 1, "2 Kings": 25, "2 Peter": 3, "2 Samuel": 24,
      "2 Thessalonians": 3, "2 Timothy": 4, "3 John": 1, "Acts": 28, "Amos": 9,
      "Colossians": 4, "Daniel": 12, "Deuteronomy": 34, "Ecclesiastes": 12,
      "Ephesians": 6, "Esther": 10, "Exodus": 40, "Ezekiel": 48, "Ezra": 10,
      "Galatians": 6, "Genesis": 50, "Habakkuk": 3, "Haggai": 2, "Hebrews": 13,
      "Hosea": 14, "Isaiah": 33, "James": 5, "Jeremiah": 52, "Job": 42,
      "Joel": 3, "John": 21, "Jonah": 4, "Joshua": 24, "Jude": 1, "Judges": 21,
      "Lamentations": 5, "Leviticus": 27, "Luke": 24, "Malachi": 4, "Mark": 16,
      "Matthew": 28, "Micah": 7, "Nahum": 3, "Nehemiah": 13, "Numbers": 36,
      "Obadiah": 1, "Philemon": 1, "Philippians": 4, "Proverbs": 31, "Psalms": 150,
      "Revelation": 22, "Romans": 16, "Ruth": 4, "Song of Solomon": 8, "Titus": 3,
      "Zechariah": 14, "Zephaniah": 3
    };

    let allQuestions = [], quizQuestions = [], currentIdx = 0;
    let earned = 0, possible = 0, userName = '';
    let timerInterval = null, timeLeft = 30;
    let questionLogs = [];  // Per-question data
    let quizStartTime = 0;  // Overall quiz time
    let currentQuestionData = {};  // Temp for current q
    let selectedChapters = [];  // From startQuiz

    // Wizard variables
    let currentStep = 0;
    const totalSteps = 10; // 0 intro + 8 chapters + 1 closing = 10

    // Navigation functions
    function showIsaiahSummary() {
      document.getElementById('isaiah-summary').classList.remove('hidden');
      document.getElementById('config').classList.add('hidden');
      document.getElementById('quiz').classList.add('hidden');
      document.getElementById('summary').classList.add('hidden');
      document.getElementById('backToConfig').style.display = 'inline-block';
      initWizard(); // Initialize or resume wizard
    }

    function showConfig() {
      document.getElementById('isaiah-summary').classList.add('hidden');
      document.getElementById('config').classList.remove('hidden');
      document.getElementById('quiz').classList.add('hidden');
      document.getElementById('summary').classList.add('hidden');
      document.getElementById('backToConfig').style.display = 'none';
    }

    // Wizard functions
    function initWizard() {
      // Load progress from localStorage
      const savedStep = localStorage.getItem('isaiahStep');
      currentStep = savedStep !== null ? parseInt(savedStep) : 0;

      if (currentStep >= totalSteps) {
        showFinished();
        return;
      }

      updateStep();
    }

    function updateStep() {
      // Hide all steps
      for (let i = 0; i < totalSteps; i++) {
        document.getElementById(`step-${i}`).classList.remove('active');
      }

      // Show current step
      document.getElementById(`step-${currentStep}`).classList.add('active');

      // Update progress
      document.getElementById('wizard-progress').textContent = `Step ${currentStep + 1} of ${totalSteps}`;

      // Update buttons
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');
      prevBtn.disabled = currentStep === 0;
      nextBtn.textContent = currentStep === totalSteps - 1 ? 'Finish! üéâ' : 'Next ‚Üí';

      // Save progress
      localStorage.setItem('isaiahStep', currentStep);

      // Hide finished if not done
      document.getElementById('wizard-finished').classList.add('hidden');
      document.getElementById('wizard-buttons').classList.remove('hidden');
    }

    function nextStep() {
      if (currentStep < totalSteps - 1) {
        currentStep++;
        updateStep();
      } else {
        currentStep = totalSteps;
        localStorage.setItem('isaiahStep', currentStep);
        showFinished();
      }
    }

    function prevStep() {
      if (currentStep > 0) {
        currentStep--;
        updateStep();
      }
    }

    function showFinished() {
      document.getElementById('wizard-buttons').classList.add('hidden');
      document.getElementById('wizard-progress').classList.add('hidden');
      for (let i = 0; i < totalSteps; i++) {
        document.getElementById(`step-${i}`).classList.remove('active');
      }
      document.getElementById('wizard-finished').classList.remove('hidden');
    }

    function resetWizard() {
      currentStep = 0;
      localStorage.setItem('isaiahStep', currentStep);
      document.getElementById('wizard-finished').classList.add('hidden');
      document.getElementById('wizard-buttons').classList.remove('hidden');
      document.getElementById('wizard-progress').classList.remove('hidden');
      updateStep();
    }

    async function loadConfig() {
      try {
        console.log('Fetching config from:', API_URL);
        const response = await fetch(API_URL);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        console.log('Loaded data:', data.length, 'questions');
        allQuestions = data;

        if (allQuestions.length === 0) {
          throw new Error('No questions found in data.');
        }

        const books = [...new Set(data.map(q => q.Book))].sort();
        const bookSel = document.getElementById('bookSelect');
        bookSel.innerHTML = '<option value="">Select a book...</option>';
        books.forEach(b => {
          const opt = document.createElement('option');
          opt.value = b; opt.textContent = b;
          bookSel.appendChild(opt);
        });
        
        // ‚úÖ Default to Isaiah if it exists
        if (books.includes("Isaiah")) {
          bookSel.value = "Isaiah";
          // Automatically load Isaiah‚Äôs chapters too
          const maxCh = chaptersPerBook["Isaiah"] || 1;
          const chapSel = document.getElementById('chapterSelect');
          chapSel.innerHTML = '';
          for (let i = 1; i <= maxCh; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = `Chapter ${i}`;
            chapSel.appendChild(opt);
          }
        }

        bookSel.onchange = () => {
          const selBook = bookSel.value;
          if (!selBook) return;

          const maxCh = chaptersPerBook[selBook] || 1;
          const chapters = Array.from({length: maxCh}, (_, i) => i + 1);

          const chapSel = document.getElementById('chapterSelect');
          chapSel.innerHTML = '<option value="">Select chapters...</option>';
          chapters.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c; opt.textContent = `Chapter ${c}`;
            chapSel.appendChild(opt);
          });
        };
        console.log('Config loaded successfully!');
      } catch (error) {
        console.error('Load config failed:', error);
        alert(`Error loading quiz config: ${error.message}\n\nCheck browser console (F12) for details. Likely: API not public‚Äîredeploy with "Anyone" access.`);
      }
    }

    async function startQuiz() {
      userName = document.getElementById('userName').value.trim();
      const book = document.getElementById('bookSelect').value;
      const chapSel = document.getElementById('chapterSelect');
      selectedChapters = Array.from(chapSel.selectedOptions).map(o => o.value).filter(c => c);
      const n = document.getElementById('numQuestions').value;

      if (!userName || !book || selectedChapters.length === 0) {
        alert('Please select your name, a book, and at least one chapter.');
        return;
      }

      // ‚úÖ Add timestamp to avoid cached responses
      const url = `${API_URL}?book=${encodeURIComponent(book)}&chapters=${selectedChapters.join(',')}&n=${n}&t=${Date.now()}`;
      console.log('Fetching quiz from:', url);

      try {
        const response = await fetch(url);
        const text = await response.text();  // Read as text to inspect

        // üß© Detect bad responses
        if (text.startsWith('<') || text.includes('DOCTYPE')) {
          throw new Error("Received HTML instead of JSON ‚Äî check Google Script permissions (must be public).");
        }

        // Try parsing JSON manually to catch truncation errors
        let parsed;
        try {
          parsed = JSON.parse(text);
        } catch (parseErr) {
          console.error("JSON parsing failed:", parseErr, "\nRaw text:", text.slice(0, 500));
          throw new Error("Invalid JSON returned from the server ‚Äî possibly incomplete or timed out.");
        }

        // ‚úÖ Validate quiz array and structure
        if (!Array.isArray(parsed) || parsed.length === 0) {
          throw new Error("No questions returned. Check if your Google Sheet has matching data.");
        }

        const validQs = parsed.filter(q => q.QuestionText?.trim() || q.Question?.trim());
        if (validQs.length === 0) {
          throw new Error("Questions loaded, but none have text fields ‚Äî check your Sheet headers (must include 'QuestionText' or 'Question').");
        }

        quizQuestions = validQs;
        console.log(`Loaded ${quizQuestions.length} valid questions for ${book}.`);

        // ‚úÖ Show quiz
        document.getElementById('config').classList.add('hidden');
        document.getElementById('quiz').classList.remove('hidden');
        currentIdx = 0; earned = 0; possible = 0;
        questionLogs = [];  
        quizStartTime = Date.now();
        showQuestion();

      } catch (error) {
        console.error("Start quiz failed:", error);
        alert(`‚ö†Ô∏è Error fetching questions:\n\n${error.message}\n\nCheck browser console (F12) for full details.`);
      }
    }

    function showQuestion() {
      clearInterval(timerInterval);
      const q = quizQuestions[currentIdx];
      document.getElementById('ref').textContent = `${q.Book} ${q.Chapter}:${q.Verse}`;
      const questionText = q.QuestionText || q.Question || "‚ö†Ô∏è (No question text found)";
      document.getElementById('qtext').innerHTML = `
        ${questionText}
        <div style="font-size:1rem; color:#555; margin-top:0.5rem;">
          <strong> ${q.MarkValue || 1} point${(q.MarkValue || 1) > 1 ? 's' : ''}</strong>
        </div>
      `;
      document.getElementById('answer').style.display = 'none';
      document.getElementById('answer').innerHTML = `<strong>Answer:</strong> ${q.AnswerText}`;
      // ‚úÖ Show text input only for high-value questions (MarkValue >= 3)
      const inputEl = document.getElementById('userInput');
      if ((parseInt(q.MarkValue) || 1) >= 3) {
        inputEl.style.display = 'block';
        inputEl.value = '';  // Clear old input
        inputEl.placeholder = 'Type your answer before revealing...';
      } else {
        inputEl.style.display = 'none';
      }
      document.getElementById('showAnswer').classList.remove('hidden');
      document.getElementById('skipBtn').classList.remove('hidden');
      document.getElementById('preAnswerOptions').classList.remove('hidden');
      document.getElementById('markOptions').classList.add('hidden');
      document.getElementById('progress').textContent = `${currentIdx + 1} / ${quizQuestions.length}`;

      // Initialize current question data
      currentQuestionData = {
        ref: `${q.Book} ${q.Chapter}:${q.Verse}`,
        difficulty: q.Difficulty || 'Unknown',
        topic: q.Topic || 'General',
        questionStartTime: Date.now(),
        marked: false,
        timedOut: false
      };

      timeLeft = 25;
      document.getElementById('timer').textContent = timeLeft;
      document.getElementById('timer').classList.remove('hidden');

      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          onTimeout();
        }
      }, 1000);
    }

    // User clicks Show Answer during timer
    function onShowAnswer() {
      clearInterval(timerInterval);
      const userTyped = document.getElementById('userInput').value.trim();
      currentQuestionData.userTypedAnswer = userTyped || '(no answer given)';
      revealAnswerForFeedback('showAnswer');
    }

    // User clicks Skip during timer
    function onSkip() {
      clearInterval(timerInterval);
      // Reveal answer, mark incorrect, log, then advance automatically after short pause
      revealAnswerImmediateIncorrect();
    }

    // Timer reached 0: reveal answer and wait for user feedback (same as show answer)
    function onTimeout() {
      currentQuestionData.timedOut = true;
    
      // Stop timer and alert user
      document.getElementById('timer').textContent = '‚è∞ Time‚Äôs up!';
      document.getElementById('timer').style.color = '#f44336';
      clearInterval(timerInterval);
    
      // Keep answer hidden ‚Äî user must still press "Show Answer"
      //alert('‚è∞ Time‚Äôs up! Press "Show Answer" to see the answer.');
    }

    function revealAnswerForFeedback(trigger) {
      // Show the answer and the mark buttons; wait for user to mark
      document.getElementById('answer').style.display = 'block';
      document.getElementById('preAnswerOptions').classList.add('hidden');
      document.getElementById('markOptions').classList.remove('hidden');
      document.getElementById('timer').classList.add('hidden');

      // record time to view the answer
      currentQuestionData.timeToViewAnswer = Math.round((Date.now() - currentQuestionData.questionStartTime) / 1000);
      currentQuestionData.clickPattern = trigger;
      console.log(`Answer revealed (${trigger}). timeToViewAnswer: ${currentQuestionData.timeToViewAnswer}s`);
    }

    function revealAnswerImmediateIncorrect() {
      document.getElementById('answer').style.display = 'block';
      document.getElementById('preAnswerOptions').classList.add('hidden');
      document.getElementById('markOptions').classList.add('hidden');
      document.getElementById('timer').classList.add('hidden');

      // mark as skipped/incorrect immediately
      const marks = parseInt(quizQuestions[currentIdx].MarkValue) || 1;
      possible += marks;
      // earned unchanged (incorrect)
      currentQuestionData.responseTime = Math.round((Date.now() - currentQuestionData.questionStartTime) / 1000);
      currentQuestionData.timeToViewAnswer = Math.round((Date.now() - currentQuestionData.questionStartTime) / 1000);
      currentQuestionData.correct = false;
      currentQuestionData.selection = 'skip';
      currentQuestionData.marked = true;
      currentQuestionData.clickPattern = 'skip';

      logQuestion(currentQuestionData); // pushes into questionLogs

      // short pause so user can see answer, then advance
      setTimeout(() => {
        advanceQuestion();
      }, 1200); // 1.2s pause for visibility
    }

    function markAnswer(correct) {
      if (currentQuestionData.marked) {
        // guard against double-marking
        return;
      }

      const marks = parseInt(quizQuestions[currentIdx].MarkValue) || 1;
      if (correct) earned += marks;
      possible += marks;

      currentQuestionData.responseTime = Math.round((Date.now() - currentQuestionData.questionStartTime) / 1000);
      currentQuestionData.correct = !!correct;
      currentQuestionData.selection = correct ? 'correct' : 'incorrect';
      currentQuestionData.marked = true;
      currentQuestionData.clickPattern = 'markAnswer';

      // Log and advance immediately
      logQuestion(currentQuestionData);

      // auto-advance shortly to give visual confirmation
      setTimeout(() => {
        advanceQuestion();
      }, 400); // short delay to let user see their action
    }

    function advanceQuestion() {
      currentIdx++;
      if (currentIdx < quizQuestions.length) {
        showQuestion();
      } else {
        showSummary();
      }
    }

    async function showSummary() {
      clearInterval(timerInterval);
      const overallTimeMinutes = Math.round((Date.now() - quizStartTime) / 1000 / 60);  // Minutes
      const correctCount = questionLogs.filter(log => log.correct).length;
      const incorrectCount = questionLogs.length - correctCount;
      const skippedCount = questionLogs.filter(log => log.selection === 'skip').length;

      document.getElementById('quiz').classList.add('hidden');
      const sum = document.getElementById('summary');
      sum.classList.remove('hidden');
      document.getElementById('nameDisplay').textContent = userName;
      document.getElementById('totalQ').textContent = quizQuestions.length;
      document.getElementById('earned').textContent = earned;
      document.getElementById('possible').textContent = possible;
      document.getElementById('percent').textContent = possible ? Math.round(earned / possible * 100) : 0;

      // Log all data (#7 Completion)
      const logData = new URLSearchParams({
        action: 'logQuiz',
        name: userName,
        score: possible ? Math.round(earned / possible * 100) : 0,
        questions: quizQuestions.length,
        correct: correctCount,
        incorrect: incorrectCount,
        skipped: skippedCount,
        overallTime: overallTimeMinutes,
        chapters: selectedChapters.join(','),
        questionLogs: JSON.stringify(questionLogs)  // Stringify array for param
      });

      console.log('Sending full log:', logData.toString());
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: logData
        });
        if (response.ok) {
          console.log('Full log sent successfully!');
        } else {
          console.error('Log failed:', response.status);
        }
      } catch (err) {
        console.error('Full log failed:', err);
      }
    }

    function logQuestion(qData) {
      // Ensure required fields exist with sensible defaults
      const timeToView = qData.timeToViewAnswer || 0;
      const responseTime = qData.responseTime || 0;
      const difficulty = qData.difficulty || 'Unknown';
      const clickPattern = qData.clickPattern || 'unknown';
      const progressIdx = currentIdx + 1;

      const logEntry = {
        ref: qData.ref,
        correct: !!qData.correct,
        selection: qData.selection || (qData.correct ? 'correct' : 'incorrect'),
        timeToViewAnswer: timeToView,
        responseTime: responseTime,
        difficultyFeedback: difficulty,
        clickPattern: clickPattern,
        progressIdx: progressIdx,
        isSkipped: qData.selection === 'skip'
      };

      questionLogs.push(logEntry);
      console.log('Logged question data:', logEntry);
    }

    // Start
    loadConfig();
  </script>
</body>
</html>
